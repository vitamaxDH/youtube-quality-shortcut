"use strict";(()=>{var T=!1,b=!1,f=!1,p="YOUTUBE_QUALITY_EXTENSION_INTERNAL",O=navigator,c=/Mac/i.test(O.userAgentData?.platform||navigator.platform||""),u=Object.freeze({qualityDown:c?"\u2318 + \u21E7 + 1":"Ctrl + Shift + 1",qualityUp:c?"\u2318 + \u21E7 + 2":"Ctrl + Shift + 2",lowest:c?"\u2318 + \u21E7 + 9":"Ctrl + Shift + 9",highest:c?"\u2318 + \u21E7 + 0":"Ctrl + Shift + 0"}),r=Object.freeze({popupContainer:"ytd-popup-container",dialogElement:"TP-YT-PAPER-DIALOG",dialogScrollable:"tp-yt-paper-dialog-scrollable",sectionRenderer:"ytd-hotkey-dialog-section-renderer",subTitle:'div[id="sub-title"]',options:'div[id="options"]',shortcutOption:"ytd-hotkey-dialog-section-option-renderer",label:'div[id="label"]',hotkey:'div[id="hotkey"]'}),Q=1e3,l="YouTube Quality Shortcut",S="yt-quality-shortcut-section";async function C(t){return T?Promise.resolve():new Promise((i,o)=>{try{let e=document.createElement("script");e.src=t,e.addEventListener("load",()=>{T=!0,setTimeout(i,100)},{once:!0}),e.addEventListener("error",()=>{o(new Error(`Failed to load ${l} control script`))},{once:!0}),document.body.appendChild(e)}catch(e){o(e)}})}chrome.runtime.onMessage.addListener((t,i,o)=>(console.log(`${l}: Received message:`,t),t.command==="get_quality_info"?(v().then(e=>{o({success:!0,currentQuality:e.currentQuality,availableQualities:e.availableQualities})}).catch(e=>{console.error(`${l}:`,e),o({success:!1,error:e.message})}),!0):(C(chrome.runtime.getURL("control.js")).then(()=>{let e={source:p,type:t.command==="set_specific_quality"?"SET_SPECIFIC_QUALITY":t.command==="lowest_quality"||t.command==="highest_quality"?"SET_EXTREME_QUALITY":"CHANGE_QUALITY",payload:{}};t.command==="set_specific_quality"&&t.quality?e.payload={quality:t.quality}:t.command==="lowest_quality"?e.payload={highest:!1}:t.command==="highest_quality"?e.payload={highest:!0}:t.command==="increase_quality"?e.payload={increase:!0}:t.command==="decrease_quality"&&(e.payload={increase:!1}),window.postMessage(e,"*"),["increase_quality","decrease_quality","highest_quality","lowest_quality","set_specific_quality"].includes(t.command)?setTimeout(()=>{v().then(n=>{o({success:!0,newQuality:n.currentQuality})}).catch(()=>{o({success:!0})})},100):o({success:!0})}).catch(e=>{console.error(`${l}:`,e),o({success:!1,error:e.message})}),!0)));function v(){return new Promise((t,i)=>{try{C(chrome.runtime.getURL("control.js")).then(()=>{let o=Date.now().toString(),e=n=>{if(n.source!==window||n.data?.source!==p)return;let a=n.data;a.type==="QUALITY_INFO_RESPONSE"&&a.requestId===o&&(window.removeEventListener("message",e),a.payload&&a.payload.success?t({success:!0,currentQuality:a.payload.currentQuality,availableQualities:a.payload.availableQualities}):t({success:!1,error:a.payload?.error||"Unknown error"}))};window.addEventListener("message",e);let s={source:p,type:"GET_QUALITY_INFO",requestId:o};window.postMessage(s,"*"),setTimeout(()=>{window.removeEventListener("message",e),i(new Error("Timed out waiting for quality info"))},1e3)}).catch(o=>{i(o)})}catch(o){i(o)}})}function h(){if(f)return;let t=document.querySelector(r.popupContainer);if(!t){setTimeout(h,Q);return}f=!0;let i=new MutationObserver(o=>{for(let{type:e,addedNodes:s}of o)if(e==="childList"){for(let n of Array.from(s))if(n.nodeName===r.dialogElement&&!n.observed){n.observed=!0,q(n),i.disconnect(),f=!1;break}}});i.observe(t,{childList:!0,subtree:!0})}function q(t){let i=new MutationObserver(o=>{for(let e of o)if(e.type==="attributes"&&e.attributeName==="style"&&window.getComputedStyle(t).display!=="none"&&!b){b=!0,requestAnimationFrame(()=>{N(),i.disconnect()});break}});i.observe(t,{attributes:!0,attributeFilter:["style"]})}function N(){try{let t=document.querySelector(r.dialogScrollable);if(!t)return;let i=Array.from(t.querySelectorAll(r.sectionRenderer));if(!i.length)return;let o=i.find(g=>g.querySelector(r.subTitle)?.textContent?.toLowerCase()==="general");if(!o||o.querySelector(`.${S}`)||Array.from(o.querySelectorAll(r.subTitle)).find(g=>g.textContent===l))return;let s=o.querySelector(r.subTitle),n=o.querySelector(r.options),a=n?.querySelector(r.shortcutOption);if(!s||!n||!a)return;let y=document.createDocumentFragment(),m=s.cloneNode(!1);m.textContent=l,m.classList.add(S),y.appendChild(m);let E=n.cloneNode(!1),L=d(a,"Quality Up",u.qualityUp),w=d(a,"Quality Down",u.qualityDown),_=d(a,"Lowest Quality",u.lowest),M=d(a,"Highest Quality",u.highest);E.append(w,L,_,M),y.appendChild(E),o.appendChild(y)}catch(t){console.error(`${l}: Failed to modify keyboard shortcut guide`,t)}}function d(t,i,o){let e=t.cloneNode(!0),s=e.querySelector(r.label),n=e.querySelector(r.hotkey);return s&&(s.textContent=i),n&&(n.textContent=o),e}console.log(`${l}: Content script loaded on`,window.location.href);document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h):h();})();
