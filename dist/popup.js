"use strict";(()=>{console.log("Popup script loaded");var m=["highres","hd2880","hd2160","hd1440","hd1080","hd720","large","medium","small","tiny"],s=null,n=[],l=null,b=!1,c=null,H=1e3,i=document.getElementById("qualitySlider"),I=document.getElementById("currentQuality"),f=document.getElementById("lowestQuality"),g=document.getElementById("highestQuality"),v=document.getElementById("statusMessage"),q=document.getElementById("quality-markers"),y=document.getElementById("slider-tooltip");document.addEventListener("DOMContentLoaded",S);async function S(){try{let e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||e.length===0){o("No active tab found","error");return}let t=e[0];if(s=t.id,!t.url||!(t.url.includes("youtube.com/watch")||t.url.includes("www.youtube.com/watch"))){o("Not a YouTube video page","warning"),E();return}O(),$(),k(),window.addEventListener("unload",w)}catch(e){console.error("Error initializing popup:",e),o("Failed to initialize controls","error")}}function k(){c||(c=window.setInterval(()=>{s&&_()},H))}function w(){c&&(clearInterval(c),c=null)}function _(){s&&chrome.tabs.sendMessage(s,{command:"get_quality_info"},e=>{chrome.runtime.lastError||!e||!e.success||P(e)})}function P(e){if(!e.availableQualities||e.availableQualities.length===0)return;let t=e.currentQuality?e.currentQuality.id:null,a=l?l.id:null;t!==a&&(n=e.availableQualities.filter(r=>r.id!=="auto").sort((r,u)=>m.indexOf(r.id)-m.indexOf(u.id)),l=e.currentQuality||null,b=!1,i.max=(n.length-1).toString(),i.step="1",h(),h(),p(),T())}function O(){i.addEventListener("input",V),i.addEventListener("change",z),f.addEventListener("change",()=>{f.checked&&Q("lowest_quality")}),g.addEventListener("change",()=>{g.checked&&Q("highest_quality")}),N(),i.addEventListener("mousemove",D),i.addEventListener("mouseleave",()=>{y.classList.remove("visible")})}function D(e){if(!n.length)return;let t=i.getBoundingClientRect(),r=Math.max(0,Math.min(e.clientX-t.left,t.width))/t.width,u=parseInt(i.max),C=r*u,M=Math.round(C),R=n.length-1-M,d=n[R];if(d){let L=d.label;d.tag&&d.tag!=="HD"&&(L+=` ${d.tag}`),y.textContent=L;let B=M/u*100;y.style.left=`${B}%`,y.classList.add("visible")}}function N(){let e=document.getElementById("coffeeBtn");e&&e.addEventListener("click",t=>{window.open("https://buymeacoffee.com/vitamaxdh","_blank")})}function V(){n.length&&(b=!0,F())}function z(){if(!n.length)return;let e=x(),t=n[e]?.id;t&&Q("set_specific_quality",{quality:t})}function x(){let e=parseInt(i.value,10),t=n.length-1-e;return Math.max(0,Math.min(t,n.length-1))}function F(){if(!n.length)return;let e=x(),t=n[e];if(t){let a=t.label;t.tag&&(a+=` <span class="quality-tag">${t.tag}</span>`),I.innerHTML=a}}function T(){if(q.innerHTML="",!!n.length)for(let e=n.length-1;e>=0;e--){let t=document.createElement("div");t.className="marker";let a=n.length-1-parseInt(i.value);e===a&&t.classList.add("active"),q.appendChild(t)}}function $(){s&&chrome.tabs.sendMessage(s,{command:"get_quality_info"},e=>{let t=chrome.runtime.lastError;if(t){console.error("Error getting quality info:",t.message),o("Could not retrieve quality information","error");return}e&&e.success?A(e):(o("Failed to get quality information","error"),E())})}function A(e){if(w(),!e.availableQualities||e.availableQualities.length===0){o("No quality levels available","warning"),E();return}n=e.availableQualities.filter(t=>t.id!=="auto").sort((t,a)=>m.indexOf(t.id)-m.indexOf(a.id)),l=e.currentQuality||null,Y(),i.max=(n.length-1).toString(),i.step="1",h(),p(),T(),o("Ready","success")}function h(){if(!n.length||!l)return;let e=n.findIndex(t=>t.id===l.id);if(e>=0&&!b){let t=n.length-1-e;i.value=t.toString();let a=l.label;l.tag&&(a+=` <span class="quality-tag">${l.tag}</span>`),I.innerHTML=a}}function p(){if(!n.length||!l)return;let e=l.id===n[0].id,t=l.id===n[n.length-1].id;g.checked=e,f.checked=t}function Y(){i.disabled=!1,f.disabled=!1,g.disabled=!1}function E(){i.disabled=!0,f.disabled=!0,g.disabled=!0,I.textContent="Not available"}function Q(e,t={}){if(!s)return;let a={command:e,...t};o("Changing quality...","info"),chrome.tabs.sendMessage(s,a,r=>{let u=chrome.runtime.lastError;if(u){console.error("Error sending command:",u.message),o("Error changing quality","error");return}r&&r.success?(r.newQuality&&(l=r.newQuality,h(),p()),o("Quality changed successfully","success")):o("Failed to change quality","error")})}function o(e,t="info"){v&&(v.title=e,v.classList.toggle("connected",t==="success"))}})();
