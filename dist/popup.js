"use strict";(()=>{console.log("Popup script loaded");var m=["highres","hd2880","hd2160","hd1440","hd1080","hd720","large","medium","small","tiny"],s=null,n=[],o=null,p=!1,c=null,H=1e3,l=document.getElementById("qualitySlider"),I=document.getElementById("currentQuality"),f=document.getElementById("lowestQuality"),g=document.getElementById("highestQuality"),v=document.getElementById("statusMessage"),q=document.getElementById("quality-markers"),y=document.getElementById("slider-tooltip");document.addEventListener("DOMContentLoaded",S);async function S(){try{let e=chrome.runtime.getManifest(),t=document.getElementById("appVersion");t&&(t.textContent=`v${e.version}`);let i=await chrome.tabs.query({active:!0,currentWindow:!0});if(!i||i.length===0){r("No active tab found","error");return}let a=i[0];if(s=a.id,!a.url||!(a.url.includes("youtube.com/watch")||a.url.includes("www.youtube.com/watch"))){r("Not a YouTube video page","warning"),E();return}O(),F(),k(),window.addEventListener("unload",w)}catch(e){console.error("Error initializing popup:",e),r("Failed to initialize controls","error")}}function k(){c||(c=window.setInterval(()=>{s&&_()},H))}function w(){c&&(clearInterval(c),c=null)}function _(){s&&chrome.tabs.sendMessage(s,{command:"get_quality_info"},e=>{chrome.runtime.lastError||!e||!e.success||P(e)})}function P(e){if(!e.availableQualities||e.availableQualities.length===0)return;let t=e.currentQuality?e.currentQuality.id:null,i=o?o.id:null;t!==i&&(n=e.availableQualities.filter(a=>a.id!=="auto").sort((a,u)=>m.indexOf(a.id)-m.indexOf(u.id)),o=e.currentQuality||null,p=!1,l.max=(n.length-1).toString(),l.step="1",h(),h(),b(),T())}function O(){l.addEventListener("input",V),l.addEventListener("change",$),f.addEventListener("change",()=>{f.checked&&Q("lowest_quality")}),g.addEventListener("change",()=>{g.checked&&Q("highest_quality")}),N(),l.addEventListener("mousemove",D),l.addEventListener("mouseleave",()=>{y.classList.remove("visible")})}function D(e){if(!n.length)return;let t=l.getBoundingClientRect(),a=Math.max(0,Math.min(e.clientX-t.left,t.width))/t.width,u=parseInt(l.max),C=a*u,M=Math.round(C),R=n.length-1-M,d=n[R];if(d){let L=d.label;d.tag&&d.tag!=="HD"&&(L+=` ${d.tag}`),y.textContent=L;let B=M/u*100;y.style.left=`${B}%`,y.classList.add("visible")}}function N(){let e=document.getElementById("coffeeBtn");e&&e.addEventListener("click",t=>{window.open("https://buymeacoffee.com/vitamaxdh","_blank")})}function V(){n.length&&(p=!0,z())}function $(){if(!n.length)return;let e=x(),t=n[e]?.id;t&&Q("set_specific_quality",{quality:t})}function x(){let e=parseInt(l.value,10),t=n.length-1-e;return Math.max(0,Math.min(t,n.length-1))}function z(){if(!n.length)return;let e=x(),t=n[e];if(t){let i=t.label;t.tag&&(i+=` <span class="quality-tag">${t.tag}</span>`),I.innerHTML=i}}function T(){if(q.innerHTML="",!!n.length)for(let e=n.length-1;e>=0;e--){let t=document.createElement("div");t.className="marker";let i=n.length-1-parseInt(l.value);e===i&&t.classList.add("active"),q.appendChild(t)}}function F(){s&&chrome.tabs.sendMessage(s,{command:"get_quality_info"},e=>{let t=chrome.runtime.lastError;if(t){console.error("Error getting quality info:",t.message),r("Could not retrieve quality information","error");return}e&&e.success?A(e):(r("Failed to get quality information","error"),E())})}function A(e){if(w(),!e.availableQualities||e.availableQualities.length===0){r("No quality levels available","warning"),E();return}n=e.availableQualities.filter(t=>t.id!=="auto").sort((t,i)=>m.indexOf(t.id)-m.indexOf(i.id)),o=e.currentQuality||null,Y(),l.max=(n.length-1).toString(),l.step="1",h(),b(),T(),r("Ready","success")}function h(){if(!n.length||!o)return;let e=n.findIndex(t=>t.id===o.id);if(e>=0&&!p){let t=n.length-1-e;l.value=t.toString();let i=o.label;o.tag&&(i+=` <span class="quality-tag">${o.tag}</span>`),I.innerHTML=i}}function b(){if(!n.length||!o)return;let e=o.id===n[0].id,t=o.id===n[n.length-1].id;g.checked=e,f.checked=t}function Y(){l.disabled=!1,f.disabled=!1,g.disabled=!1}function E(){l.disabled=!0,f.disabled=!0,g.disabled=!0,I.textContent="Not available"}function Q(e,t={}){if(!s)return;let i={command:e,...t};r("Changing quality...","info"),chrome.tabs.sendMessage(s,i,a=>{let u=chrome.runtime.lastError;if(u){console.error("Error sending command:",u.message),r("Error changing quality","error");return}a&&a.success?(a.newQuality&&(o=a.newQuality,h(),b()),r("Quality changed successfully","success")):r("Failed to change quality","error")})}function r(e,t="info"){v&&(v.title=e,v.classList.toggle("connected",t==="success"))}})();
