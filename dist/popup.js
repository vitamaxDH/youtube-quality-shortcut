"use strict";(()=>{console.log("Popup script loaded");var y=["highres","hd2880","hd2160","hd1440","hd1080","hd720","large","medium","small","tiny"],r=null,i=[],n=null,v=!1,s=null,q=1e3,u=document.getElementById("qualitySlider"),Q=document.getElementById("currentQuality"),d=document.getElementById("lowestQuality"),c=document.getElementById("highestQuality"),m=document.getElementById("statusMessage"),p=document.getElementById("quality-markers");document.addEventListener("DOMContentLoaded",M);async function M(){try{let e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||e.length===0){l("No active tab found","error");return}let t=e[0];if(r=t.id,!t.url||!(t.url.includes("youtube.com/watch")||t.url.includes("www.youtube.com/watch"))){l("Not a YouTube video page","warning"),I();return}C(),k(),w(),window.addEventListener("unload",L)}catch(e){console.error("Error initializing popup:",e),l("Failed to initialize controls","error")}}function w(){s||(s=window.setInterval(()=>{r&&T()},q))}function L(){s&&(clearInterval(s),s=null)}function T(){r&&chrome.tabs.sendMessage(r,{command:"get_quality_info"},e=>{chrome.runtime.lastError||!e||!e.success||x(e)})}function x(e){if(!e.availableQualities||e.availableQualities.length===0)return;let t=e.currentQuality?e.currentQuality.id:null,a=n?n.id:null;t!==a&&(i=e.availableQualities.filter(o=>o.id!=="auto").sort((o,f)=>y.indexOf(o.id)-y.indexOf(f.id)),n=e.currentQuality||null,v=!1,u.max=(i.length-1).toString(),u.step="1",g(),g(),b(),H())}function C(){u.addEventListener("input",B),u.addEventListener("change",S),d.addEventListener("change",()=>{d.checked&&h("lowest_quality")}),c.addEventListener("change",()=>{c.checked&&h("highest_quality")}),R()}function R(){let e=document.getElementById("coffeeBtn");e&&e.addEventListener("click",t=>{window.open("https://buymeacoffee.com/vitamaxdh","_blank")})}function B(){i.length&&(v=!0,_())}function S(){if(!i.length)return;let e=E(),t=i[e]?.id;t&&h("set_specific_quality",{quality:t})}function E(){let e=parseInt(u.value,10),t=i.length-1-e;return Math.max(0,Math.min(t,i.length-1))}function _(){if(!i.length)return;let e=E(),t=i[e];if(t){let a=t.label;t.tag&&(a+=` <span class="quality-tag">${t.tag}</span>`),Q.innerHTML=a}}function H(){if(p.innerHTML="",!!i.length)for(let e=0;e<i.length;e++){let t=document.createElement("option");t.value=e.toString(),p.appendChild(t)}}function k(){r&&chrome.tabs.sendMessage(r,{command:"get_quality_info"},e=>{let t=chrome.runtime.lastError;if(t){console.error("Error getting quality info:",t.message),l("Could not retrieve quality information","error");return}e&&e.success?O(e):(l("Failed to get quality information","error"),I())})}function O(e){if(!e.availableQualities||e.availableQualities.length===0){l("No quality levels available","warning"),I();return}i=e.availableQualities.filter(t=>t.id!=="auto").sort((t,a)=>y.indexOf(t.id)-y.indexOf(a.id)),n=e.currentQuality||null,P(),g(),b(),l("Ready","success")}function g(){if(!i.length||!n)return;let e=i.findIndex(t=>t.id===n.id);if(e>=0&&!v){let t=i.length-1-e;u.value=t.toString();let a=n.label;n.tag&&(a+=` <span class="quality-tag">${n.tag}</span>`),Q.innerHTML=a}}function b(){if(!i.length||!n)return;let e=n.id===i[0].id,t=n.id===i[i.length-1].id;c.checked=e,d.checked=t}function P(){u.disabled=!1,d.disabled=!1,c.disabled=!1}function I(){u.disabled=!0,d.disabled=!0,c.disabled=!0,Q.textContent="Not available"}function h(e,t={}){if(!r)return;let a={command:e,...t};l("Changing quality...","info"),chrome.tabs.sendMessage(r,a,o=>{let f=chrome.runtime.lastError;if(f){console.error("Error sending command:",f.message),l("Error changing quality","error");return}o&&o.success?(o.newQuality&&(n=o.newQuality,g(),b()),l("Quality changed successfully","success")):l("Failed to change quality","error")})}function l(e,t="info"){m&&(m.title=e,m.classList.toggle("connected",t==="success"))}})();
